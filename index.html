<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Webchat example</title>

    <style>
        #container {
            width: 600px;
            margin: auto;
        }
    </style>
</head>
<body>
<div id="container">
    <header>
        <h1>A simple chat with AJAX & Node.js for Supinfo 3WEB</h1>
    </header>

    <section>
        <fieldset>
            <legend>Post your message</legend>

            <form action="." method="get" id="post-message">
                <p><label>Username <input type="text" name="username" value="Guest"/></label></p>
                <p><label>Message <input type="text" name="message"/></label></p>
                <p><input type="submit" value="Post"/></p>
            </form>
        </fieldset>

        <div id="messages"></div>
    </section>
</div>

<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
    var listContainer = document.getElementById("messages");
    var messageForm = document.querySelector('form#post-message');
    var formUsername = document.querySelector("input[name=username]");
    var formMessage  = document.querySelector("input[name=message]");
    var socket = io.connect();

    var getMessage = function (message) {
        var listItem = document.createElement("p");
        listItem.innerText = message.username + ": " + message.message;

        listContainer.insertBefore(listItem, listContainer.firstChild);
    };

    var getMessages = function (messages) {
        for (var i = 0; i < messages.length; i++) {
            getMessage(messages[i]);
        }
    };

    var addMessage = function (event) {
        event.preventDefault();

        if (formMessage.value != "") {
                var newMessage = { 'username' : formUsername.value, 'message' : formMessage.value };
                socket.emit('newMessage', newMessage);

                getMessage(newMessage);

                formMessage.value = "";
        }
    };

    messageForm.addEventListener('submit', addMessage);

    socket.on('fetchMessages', getMessages);
    socket.on('fetchNewMessage', getMessage);
</script>
</body>
</html>
